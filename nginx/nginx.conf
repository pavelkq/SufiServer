worker_processes 1;

events { worker_connections 1024; }

http {
  server {
    listen 80;

    # Проксирование фронтенда React (админка)
    location / {
      proxy_pass http://admin-frontend:3000;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
      proxy_read_timeout 300s;
      proxy_send_timeout 300s;
    }

    # WebSocket для фронтенда
    location /ws/ {
      proxy_pass http://admin-frontend:3000/ws/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "Upgrade";
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
    }

    # ==========================
    # API админ-бэкенда — конкретный маршрут для /api/admin-backend/
    # Обратите внимание: proxy_pass без завершающего слэша, чтобы не переписывать URI
    location /api/admin-backend/ {
      proxy_pass http://admin-backend:4001;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Общий маршрут для других /api/ запросов
    # proxy_pass с завершающим слэшем переписывает путь корректно для других сервисов, если нужно
    location /api/ {
      proxy_pass http://admin-backend:4001/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # API для сервиса сброса пароля — проксируются отдельно
    location /api/auth-service/password-reset/ {
      proxy_pass http://auth-service:5000/password-reset/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # API для аутентификации
    location /api/auth-service/ {
      proxy_pass http://auth-service:5000/auth/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Сервис saki-service
    location /saki/ {
      proxy_pass http://saki-service:4000/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Статическая раздача загруженных файлов - РЕАЛЬНЫЙ ПУТЬ
    location /uploads/articles/ {
        alias /opt/Sufi/uploads/articles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
    }

    # Статическая страница сброса пароля
    location /reset-password {
      alias /opt/nginx_static/reset-password.html;
      default_type text/html;
      charset utf-8;
    }
  }
}